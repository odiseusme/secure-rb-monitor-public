name: CI/CD Security Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 3 * * 0" # Runs every Sunday at 3 AM UTC

jobs:
  build:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      # Checkout code from the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Run static analysis (Linter)
      - name: Lint code
        run: |
          echo "No linter configured yet."
          # Uncomment and configure your linter (e.g., ESLint):
          # npx eslint .

      # Run syntax and shell script validation
      - name: Validate scripts
        run: |
          set -e
          for f in *.js status-*.js write_status.js static-server.js; do
            [ -f "$f" ] && node -c "$f"
          done
          for f in scripts/*.sh; do
            [ -f "$f" ] && bash -n "$f"
          done

      # Placeholder for build steps
      - name: Build application
        run: echo "Add build steps if needed."

      # Placeholder for test steps
      - name: Run tests
        run: |
          echo "No tests configured yet."
          # Uncomment and configure your testing framework:
          # npm test

      # Security checks (e.g., npm audit)
      - name: Security audit
        run: |
          npm audit || true

      # Install and run Trivy
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      - name: Run Trivy vulnerability scan
        run: trivy fs . || true

      # Install and run Gitleaks
      - name: Install Gitleaks
        run: |
          curl -sSfL https://github.com/zricethezav/gitleaks/releases/download/v8.17.0/gitleaks-linux-amd64 -o gitleaks
          chmod +x gitleaks
          mv gitleaks /usr/local/bin/gitleaks
      - name: Run Gitleaks secret scan
        run: gitleaks detect --source . || true

      # Install and run Semgrep
      - name: Install Semgrep
        run: pip install semgrep
      - name: Run Semgrep static analysis
        run: semgrep --config p/ci . || true

      # Generate workflow summary
      - name: Generate workflow summary
        run: echo "Workflow completed successfully." >> $GITHUB_STEP_SUMMARY
