<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Remote monitoring dashboard for Rosen Bridge Watchers - access health summaries from any PC or mobile device.">
  <title>Rosen Bridge Monitor</title>
  <link rel="stylesheet" href="style.css">
  <!-- Favicons (relative paths so it works from any base URL) -->
  <link rel="icon" type="image/png" href="./icons/owlHeadA_32.png?v=6" sizes="32x32">
  <link rel="apple-touch-icon" href="./icons/owlHeadA_180.png?v=6">
  <link rel="icon" href="./favicon.ico?v=6" sizes="any">
  <link rel="shortcut icon" href="./favicon.ico?v=6">
  <meta name="theme-color" content="#12181B">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="pageTitle">Rosen Bridge Monitor</h1>
      <div id="lastUpdatedTop" class="last-updated-top">Last updated: --</div>
    </div>

    <div id="loading" class="loading">Loading watchers status...</div>
    <div id="error" class="error" style="display: none;"></div>

    <div id="content" style="display: none;">
      <div class="summary" id="summary"></div>
      <div class="watchers-grid" id="watchers"></div>
      <div class="last-update" id="lastUpdate"></div>
      <div class="staleness" id="staleness"></div>
    </div>
  </div>

  <script>
    let refreshInterval;

    async function fetchStatus() {
      const response = await fetch(`status.json`);
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      return await response.json();
    }

    function getNetworkClass(network) {
      const n = String(network || 'unknown').toLowerCase();
      return `network-${n}`;
    }

    function getProgressClass(status) {
      if (status === 'exhausted') return 'progress-critical';
      if (status === 'critical')  return 'progress-warning';
      return 'progress-healthy'; // default + 'sufficient'
    }

    // ===== Client-side summary helpers =====

    // Normalize permit count from permitCount.active and permitsPerEvent.
    // Returns an integer or null if not enough data.
    function normalizedPermits(watcher) {
      const active = watcher && watcher.permitCount && typeof watcher.permitCount.active === 'number'
        ? watcher.permitCount.active : null;
      const perEvent = watcher && typeof watcher.permitsPerEvent === 'number'
        ? watcher.permitsPerEvent : null;
      if (active == null || perEvent == null || perEvent <= 0) return null;
      return Math.floor(active / perEvent);
    }

    // Aggregate health statuses into counts.
    // Anything other than 'healthy' or 'unstable' is treated as 'broken'.
    function computeHealthSummary(watchers) {
      const result = { healthy: 0, unstable: 0, broken: 0 };
      for (let i = 0; i < watchers.length; i++) {
        const hs = String(watchers[i].healthStatus || '').toLowerCase();
        if (hs === 'healthy') result.healthy++;
        else if (hs === 'unstable') result.unstable++;
        else result.broken++;
      }
      return result;
    }

    // Aggregate permit statuses into counts.
    // Prefer watcher.permitStatus.status if it exists; otherwise fall back to normalizedPermits().
    function computePermitSummary(watchers) {
      const result = { sufficient: 0, critical: 0, exhausted: 0 };
      for (let i = 0; i < watchers.length; i++) {
        const w = watchers[i];
        if (w && w.permitStatus && typeof w.permitStatus.status === 'string') {
          const ps = w.permitStatus.status.toLowerCase();
          if (ps === 'sufficient') result.sufficient++;
          else if (ps === 'critical') result.critical++;
          else result.exhausted++;
          continue;
        }
        const n = normalizedPermits(w);
        if (n == null) result.exhausted++;
        else if (n >= 2) result.sufficient++;
        else if (n === 1) result.critical++;
        else result.exhausted++;
      }
      return result;
    }

    // ===== Normalizers to align backend fields with UI needs =====

    // Build permitStatus if missing, based on permitCount and permitsPerEvent.
    function buildPermitStatus(w) {
      const perEvent = (w && typeof w.permitsPerEvent === 'number' && w.permitsPerEvent > 0) ? w.permitsPerEvent : null;
      const active = (w && w.permitCount && typeof w.permitCount.active === 'number') ? w.permitCount.active : null;
      const total  = (w && w.permitCount && typeof w.permitCount.total  === 'number') ? w.permitCount.total  : null;

      if (!perEvent || active == null || total == null) {
        return { status: 'unknown', message: 'No data', available: 0, total: 0, utilization: 0 };
      }

      const totalBlocks = Math.floor(total / perEvent);
      // If active==total use full blocks, otherwise floor(active/perEvent)
      let availableBlocks = (active === total) ? totalBlocks : Math.floor(active / perEvent);
      if (!Number.isFinite(availableBlocks) || availableBlocks < 0) availableBlocks = 0;

      let status = 'exhausted';
      if (availableBlocks >= 2) status = 'sufficient';
      else if (availableBlocks === 1) status = 'critical';

      const utilization = (totalBlocks > 0) ? (1 - (availableBlocks / totalBlocks)) : 0; // used fraction
      const message = (totalBlocks > 0) ? `${availableBlocks}/${totalBlocks} blocks` : 'No data';

      return {
        status,
        message,
        available: availableBlocks,
        total: totalBlocks,
        utilization
      };
    }

    // Normalize a watcher object for the UI:
    // - ensure .port exists (map from hostPort)
    // - ensure .permitStatus exists (compute if missing)
    function normalizeWatcher(w) {
      const out = Object.assign({}, w);
      if (out.port == null && out.hostPort != null) out.port = out.hostPort;
      if (!out.permitStatus) out.permitStatus = buildPermitStatus(out);
      return out;
    }

function renderSummary(summary) {
  return `
    <div class="summary-column">
      <div class="summary-column-label">WATCHERS</div>

      <div class="summary-card healthy">
        <h3>
          <span class="count-num">${summary.healthy}</span>
          <span class="count-div">/</span>
          <span class="count-den">${summary.total}</span>
        </h3>
        <p>Healthy</p>
      </div>

      <div class="summary-card unstable">
        <h3>
          <span class="count-num">${summary.unstable}</span>
          <span class="count-div">/</span>
          <span class="count-den">${summary.total}</span>
        </h3>
        <p>Unstable</p>
      </div>

      <div class="summary-card broken">
        <h3>
          <span class="count-num">${summary.broken}</span>
          <span class="count-div">/</span>
          <span class="count-den">${summary.total}</span>
        </h3>
        <p>Broken</p>
      </div>
    </div>

    <div class="summary-column">
      <div class="summary-column-label">PERMIT STATUS</div>
      <div class="summary-card sufficient"><h3>${summary.sufficient}</h3><p>Sufficient</p></div>
      <div class="summary-card critical"><h3>${summary.critical}</h3><p>Critical</p></div>
      <div class="summary-card exhausted"><h3>${summary.exhausted}</h3><p>Exhausted</p></div>
    </div>`;
}

    function renderWatcher(watcher) {
      const permitStatus = watcher.permitStatus || {
        status: 'unknown',
        message: 'No data'
      };

      const formatBalance = (b) => (typeof b === 'number' ? b.toFixed(2) : '0');
      const formatERG = (b) => (typeof b === 'number' ? b.toFixed(2) : '0');
      const cleanName = watcher.container ? watcher.container.replace(/-service-1$/, '') : (watcher.name || '');

      // Prefer available/total; fallback to utilization (which is "used" fraction)
      const avail = Number.isFinite(permitStatus.available) ? permitStatus.available : 0;
      const total = Number.isFinite(permitStatus.total) ? permitStatus.total : 0;

      let percent = 0;
      if (total > 0) {
        percent = Math.round((avail / total) * 100);
      } else if (typeof permitStatus.utilization === 'number') {
        const u = Math.max(0, Math.min(1, permitStatus.utilization));
        percent = Math.round((1 - u) * 100);
      }
      percent = Math.max(0, Math.min(100, percent)); // clamp

      const permitsHTML = `
        <div class="status-row-2col">
          <div class="status-col"><strong>Permits:</strong> ${avail}/${total}</div>
          <div class="status-col right"><strong>Status:</strong>
            <span class="permit-${permitStatus.status.replace(/\s+/g, '-').toLowerCase()}">${permitStatus.message || ''}</span>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill ${getProgressClass(permitStatus.status)}" style="width:${percent}%"></div>
        </div>
      `;

      return `
        <div class="watcher-card">
          <div class="watcher-header">
            <div class="watcher-name">${cleanName}</div>
            <div class="network-badge ${getNetworkClass(watcher.network)}">${watcher.network}</div>
          </div>

          <div class="status-row-2col">
            <div class="status-col"><strong>Health:</strong>
              <span class="${
                watcher.healthStatus === 'Healthy'
                  ? 'health-green'
                  : watcher.healthStatus === 'Unstable'
                  ? 'health-orange'
                  : watcher.healthStatus === 'Broken'
                  ? 'health-red'
                  : watcher.healthStatus === 'Offline'
                  ? 'health-down'
                  : ''
              }">${watcher.healthStatus || 'Unknown'}</span>
            </div>
            <div class="status-col right"><strong>Port:</strong> ${watcher.port ?? ''}</div>
          </div>

          ${permitsHTML}

          <hr class="balances-separator">
          <div class="balances-row">
            <div><span class="status-label">ERG:</span>  <span class="status-value">${formatERG(watcher.currentBalance)}</span></div>
            <div><span class="status-label">eRSN:</span> <span class="status-value">${formatBalance(watcher.eRsnBalance)}</span></div>
            <div><span class="status-label">RSN:</span>  <span class="status-value">${formatBalance(watcher.rsnBalance)}</span></div>
          </div>

          ${
            watcher.error
              ? `<div class="permit-status permit-critical"><strong>Error:</strong> ${watcher.error}</div>`
              : ''
          }
        </div>`;
    }

    async function updateDisplay() {
      try {
        const data = await fetchStatus();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // Normalize watchers and compute summary client-side
        const watchersArray = Object.values(data.watchers || {}).map(normalizeWatcher);

        const health = computeHealthSummary(watchersArray);
        const permit = computePermitSummary(watchersArray);
        const summary = {
          total: watchersArray.length,
          healthy: health.healthy,
          unstable: health.unstable,
          broken: health.broken,
          sufficient: permit.sufficient,
          critical: permit.critical,
          exhausted: permit.exhausted
        };

        document.getElementById('summary').innerHTML = renderSummary(summary);
        document.getElementById('watchers').innerHTML = watchersArray.map(renderWatcher).join('');

        if (data.lastUpdate) {
          const t = new Date(data.lastUpdate);
          const el = document.getElementById('lastUpdatedTop');
          el.textContent = `Last updated: ${t.toLocaleTimeString()}`;
          const ageSeconds = (Date.now() - t.getTime()) / 1000;
          if (ageSeconds > 30) el.classList.add('stale'); else el.classList.remove('stale');
        }
      } catch (err) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = `<strong>Error loading data:</strong> ${err.message}`;
      }
    }

    updateDisplay();
    refreshInterval = setInterval(updateDisplay, 10000);
    window.addEventListener('focus', updateDisplay);
  </script>
</body>
</html>

